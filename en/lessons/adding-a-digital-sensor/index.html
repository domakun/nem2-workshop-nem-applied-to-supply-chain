<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Adding a digital sensor | NEM blockchain applied to supply chain</title>
<meta name="generator" content="Jekyll v3.8.3" />
<meta property="og:title" content="Adding a digital sensor" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Background" />
<meta property="og:description" content="Background" />
<link rel="canonical" href="http://localhost:4000/en/lessons/adding-a-digital-sensor/" />
<meta property="og:url" content="http://localhost:4000/en/lessons/adding-a-digital-sensor/" />
<meta property="og:site_name" content="NEM blockchain applied to supply chain" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-03-11T14:48:20+08:00" />
<script type="application/ld+json">
{"headline":"Adding a digital sensor","dateModified":"2019-03-11T14:48:20+08:00","description":"Background","datePublished":"2019-03-11T14:48:20+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/en/lessons/adding-a-digital-sensor/"},"@type":"BlogPosting","url":"http://localhost:4000/en/lessons/adding-a-digital-sensor/","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/en/assets/main.css">
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/en/feed.xml" title="NEM blockchain applied to supply chain" /></head>
<body><header class="site-header" role="banner">

    <div class="wrapper"><a class="site-title" rel="author" href="/en/"><span><img src="/en/assets/logo-nem.svg"/></span> workshop.cn</a><nav class="site-nav">
            <input type="checkbox" id="nav-trigger" class="nav-trigger" />
            <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
            </label>

            <div class="trigger">
                <div class="changeLanguage">
                <select onchange="changeLanguage('/lessons/adding-a-digital-sensor/')" id="languageType">
                  <option value ="language" disabled selected>Language</option>
                  <option value ="en">English</option>
                  <option value ="ch">中文</option>
                </select>
              </div>
                <i class="fab fa-github"></i> <a class="page-link" href="/edit/master/_lessons/11-adding-a-digital-sensor.markdown"> Edit on GitHub</a>
            </div>
        </nav></div>
</header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="row">

    <div class="sidebar-wrapper col-3">
        <ol><li>
                <a href="/en/lessons/introduction/">
                    Introduction
                </a>
            </li><li>
                <a href="/en/lessons/prepare-your-workstation/">
                    Prepare your workstation
                </a>
            </li><li>
                <a href="/en/lessons/use-case/">
                    Use case: Blockchain applied to supply chain
                </a>
            </li><li>
                <a href="/en/lessons/scope-definition/">
                    Scope definition
                </a>
            </li><li>
                <a href="/en/lessons/authorisation-modelling/">
                    Authorisation modelling
                </a>
            </li><li>
                <a href="/en/lessons/data-modelling/">
                    Data modelling
                </a>
            </li><li>
                <a href="/en/lessons/solution/">
                    One possible solution
                </a>
            </li><li>
                <a href="/en/lessons/setup/">
                    Setup: Warehouse operator and safety seal
                </a>
            </li><li>
                <a href="/en/lessons/registering-products/">
                    Registering products
                </a>
            </li><li>
                <a href="/en/lessons/sending-the-safety-seal/">
                    Sending the safety seal
                </a>
            </li><li>
                <a href="/en/lessons/adding-a-digital-sensor/">
                    Adding a digital sensor
                </a>
            </li><li>
                <a href="/en/lessons/adding-another-operator/">
                    Adding another operator
                </a>
            </li><li>
                <a href="/en/lessons/future-work-multilevel-multisig-accounts/">
                    Future work
                </a>
            </li></ol>

        <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-text="NEM blockchain applied to supply chain #NEM" data-show-count="false">Tweet</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    </div>

    <div class="col-9">
        <article class="lesson h-entry" itemscope itemtype="http://schema.org/BlogPosting">

            <header class="lesson-header">
                <h1 class="lesson-title p-name" itemprop="name headline">Adding a digital sensor</h1>
            </header>

            <div class="lesson-content e-content" itemprop="articleBody">
                <h2 id="background">Background</h2>

<p>Recently, the company has included digital sensors to automatize part of the process. The goal is to decrease human errors, providing a new source of reliability.</p>

<p>The warehouse operator still needs to check that the product meets the standards. After the warehouse operator announces the safety seal request, a sensor performs a digital inspection. The digital sensor confirms or denies the safety seal request.</p>

<ul>
  <li>If accepted, the safety seal is sent to the product.</li>
  <li>If denied, the sensor sends a transaction to the product, stating the product has not passed the inspection process.</li>
</ul>

<p><img src="/en/assets/images/use-case-nem-adding-a-sensor.png" alt="use-case-nem-adding-a-sensor" /></p>

<p>If we were putting the application logic inside the blockchain, this  little change means throwing the published smart contract. This leads to  spend more time in development and increasing the cost of the platform.</p>

<p>Using NEM, we still need to change our code. In most cases, making changes takes the same as if we were developing an application that is not using blockchain technology.</p>

<h3 id="aggregated-transactions">Aggregated Transactions</h3>

<p><a href="https://nemtech.github.io/concepts/aggregate-transaction.html">Aggregated Transactions</a> merge multiple transactions into one, allowing trustless swaps and other advanced logic. NEM does this by generating a one-time disposable smart contract. When all involved accounts have cosigned the transaction, all of them are executed at once.</p>

<h2 id="solution">Solution</h2>

<h3 id="new-actor-digital-safety-sensor">New Actor: Digital Safety Sensor</h3>

<p>We should decide how we represent the digital safety sensor in our existing project.</p>

<p>The digital sensor requires to cosign transactions. That’s the reason why it is represented as an account.</p>

<p>Create digital safety sensor account.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">  nem2-cli account generate <span class="nt">--network</span> MIJIN_TEST <span class="nt">--url</span> http://localhost:3000 <span class="nt">--profile</span> sensor <span class="nt">--save</span> </code></pre></figure>

<h3 id="modify-createsafetysealtransaction-function">Modify createSafetySealTransaction function</h3>

<p>1. Open <code class="highlighter-rouge">project/dashboard/src/app/services/safetySeal.service.ts</code>, and modify <code class="highlighter-rouge">transferSafetySeal</code> function.</p>

<p>2. Create two transfer transactions:</p>

<ul>
  <li><strong>operatorToProductTransaction</strong>:Transfer Transaction to product address, sending one company.safety seal.</li>
  <li><strong>sensorToProductTransaction</strong>: Transfer Transaction to product address, with the message inspection, passed.</li>
</ul>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="nx">createSafetySealTransaction</span><span class="p">(</span><span class="nx">productAddress</span><span class="p">:</span> <span class="nx">Address</span><span class="p">,</span> <span class="nx">operatorAccount</span><span class="p">:</span> <span class="nx">PublicAccount</span><span class="p">):</span> <span class="nx">AggregateTransaction</span> <span class="p">{</span>

    <span class="kd">const</span> <span class="nx">sensorPublicKey</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span> <span class="c1">// Todo: Paste sensor account public key</span>
    <span class="kd">const</span> <span class="nx">sensorPublicAccount</span> <span class="o">=</span> <span class="nx">PublicAccount</span><span class="p">.</span><span class="nx">createFromPublicKey</span><span class="p">(</span><span class="nx">sensorPublicKey</span><span class="p">,</span> <span class="nx">NetworkType</span><span class="p">.</span><span class="nx">MIJIN_TEST</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">operatorToProductTransaction</span> <span class="o">=</span> <span class="nx">TransferTransaction</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span>
      <span class="nx">Deadline</span><span class="p">.</span><span class="nx">create</span><span class="p">(),</span>
      <span class="nx">productAddress</span><span class="p">,</span>
      <span class="p">[</span><span class="k">new</span> <span class="nx">Mosaic</span><span class="p">(</span><span class="k">new</span> <span class="nx">MosaicId</span><span class="p">(</span><span class="s1">'company.safety:seal'</span><span class="p">),</span> <span class="nx">UInt64</span><span class="p">.</span><span class="nx">fromUint</span><span class="p">(</span><span class="mi">1</span><span class="p">))],</span>
      <span class="nx">EmptyMessage</span><span class="p">,</span>
      <span class="nx">NetworkType</span><span class="p">.</span><span class="nx">MIJIN_TEST</span>
    <span class="p">);</span>

    <span class="kd">const</span> <span class="nx">sensorToProductTransaction</span> <span class="o">=</span> <span class="nx">TransferTransaction</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span>
      <span class="nx">Deadline</span><span class="p">.</span><span class="nx">create</span><span class="p">(),</span>
      <span class="nx">productAddress</span><span class="p">,</span>
      <span class="p">[],</span>
      <span class="nx">PlainMessage</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s1">'Inspection passed'</span><span class="p">),</span>
      <span class="nx">NetworkType</span><span class="p">.</span><span class="nx">MIJIN_TEST</span>
    <span class="p">);</span>
        
    <span class="p">[...]</span>  
<span class="p">}</span>   </code></pre></figure>

<p>3. Then, wrap these transfer transactions inside an aggregate transaction. State who the signers of each transaction are.</p>

<p>An aggregated transaction is complete if all required cosigners have  signed it.</p>

<p>The warehouse operator will sign and announce the transaction, so we still require the signature from the digital sensor. We call this type of transactions <code class="highlighter-rouge">aggregate bonded</code>.</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="nx">createSafetySealTransaction</span><span class="p">(</span><span class="nx">productAddress</span><span class="p">:</span> <span class="nx">Address</span><span class="p">,</span> <span class="nx">operatorAccount</span><span class="p">:</span> <span class="nx">PublicAccount</span><span class="p">):</span> <span class="nx">AggregateTransaction</span> <span class="p">{</span>

    <span class="kd">const</span> <span class="nx">sensorPublicKey</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span> <span class="c1">// Todo: Paste sensor account public key</span>
    <span class="kd">const</span> <span class="nx">sensorPublicAccount</span> <span class="o">=</span> <span class="nx">PublicAccount</span><span class="p">.</span><span class="nx">createFromPublicKey</span><span class="p">(</span><span class="nx">sensorPublicKey</span><span class="p">,</span> <span class="nx">NetworkType</span><span class="p">.</span><span class="nx">MIJIN_TEST</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">operatorToProductTransaction</span> <span class="o">=</span> <span class="nx">TransferTransaction</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span>
      <span class="nx">Deadline</span><span class="p">.</span><span class="nx">create</span><span class="p">(),</span>
      <span class="nx">productAddress</span><span class="p">,</span>
      <span class="p">[</span><span class="k">new</span> <span class="nx">Mosaic</span><span class="p">(</span><span class="k">new</span> <span class="nx">MosaicId</span><span class="p">(</span><span class="s1">'company.safety:seal'</span><span class="p">),</span> <span class="nx">UInt64</span><span class="p">.</span><span class="nx">fromUint</span><span class="p">(</span><span class="mi">1</span><span class="p">))],</span>
      <span class="nx">EmptyMessage</span><span class="p">,</span>
      <span class="nx">NetworkType</span><span class="p">.</span><span class="nx">MIJIN_TEST</span>
    <span class="p">);</span>

    <span class="kd">const</span> <span class="nx">sensorToProductTransaction</span> <span class="o">=</span> <span class="nx">TransferTransaction</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span>
      <span class="nx">Deadline</span><span class="p">.</span><span class="nx">create</span><span class="p">(),</span>
      <span class="nx">productAddress</span><span class="p">,</span>
      <span class="p">[],</span>
      <span class="nx">PlainMessage</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s1">'Inspection passed'</span><span class="p">),</span>
      <span class="nx">NetworkType</span><span class="p">.</span><span class="nx">MIJIN_TEST</span>
    <span class="p">);</span>
    
    <span class="k">return</span> <span class="nx">AggregateTransaction</span><span class="p">.</span><span class="nx">createBonded</span><span class="p">(</span>
      <span class="nx">Deadline</span><span class="p">.</span><span class="nx">create</span><span class="p">(),</span>
      <span class="p">[</span>
        <span class="nx">operatorToProductTransaction</span><span class="p">.</span><span class="nx">toAggregate</span><span class="p">(</span><span class="nx">operatorAccount</span><span class="p">),</span>
        <span class="nx">sensorToProductTransaction</span><span class="p">.</span><span class="nx">toAggregate</span><span class="p">(</span><span class="nx">sensorPublicAccount</span><span class="p">)</span>
      <span class="p">],</span>
      <span class="nx">NetworkType</span><span class="p">.</span><span class="nx">MIJIN_TEST</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>4. Open <code class="highlighter-rouge">project/dashboard/src/app/components/sendsafetySeal.component.ts</code> and edit <code class="highlighter-rouge">sendSafetySeal()</code> function.</p>

<p>When an aggregate transaction is bonded, the warehouse operator needs to lock at least <code class="highlighter-rouge">10 XEM</code>.</p>

<p>Once the sensor cosigns the aggregate transaction, the amount of locked XEM becomes available again on the warehouse operator’s account, and both transactions are executed atomically.</p>

<p>5. Create a lock funds transaction, locking 10 XEM for the hash of the signed transaction.</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="nx">sendSafetySeal</span><span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">const</span> <span class="nx">operatorAccount</span> <span class="o">=</span> <span class="nx">Account</span>
      <span class="p">.</span><span class="nx">createFromPrivateKey</span><span class="p">(</span><span class="nx">form</span><span class="p">.</span><span class="nx">privateKey</span><span class="p">,</span> <span class="nx">NetworkType</span><span class="p">.</span><span class="nx">MIJIN_TEST</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">productPublicKey</span> <span class="o">=</span> <span class="nx">Asset</span><span class="p">.</span><span class="nx">deterministicPublicKey</span><span class="p">(</span><span class="s1">'company'</span><span class="p">,</span> <span class="nx">form</span><span class="p">.</span><span class="nx">selectedProduct</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">productAddress</span> <span class="o">=</span> <span class="nx">PublicAccount</span><span class="p">.</span><span class="nx">createFromPublicKey</span><span class="p">(</span><span class="nx">productPublicKey</span><span class="p">,</span> <span class="nx">NetworkType</span><span class="p">.</span><span class="nx">MIJIN_TEST</span><span class="p">).</span><span class="nx">address</span><span class="p">;</span>

    <span class="kd">const</span> <span class="nx">safetySealTransaction</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">safetySealService</span><span class="p">.</span><span class="nx">createSafetySealTransaction</span><span class="p">(</span><span class="nx">productAddress</span><span class="p">,</span> <span class="nx">operatorAccount</span><span class="p">.</span><span class="nx">publicAccount</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">signedTransaction</span> <span class="o">=</span> <span class="nx">operatorAccount</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">safetySealTransaction</span><span class="o">!</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">lockFundsTransaction</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">safetySealService</span><span class="p">.</span><span class="nx">createLockFundsTransaction</span><span class="p">(</span><span class="nx">signedTransaction</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">signedLockFundsTransaction</span> <span class="o">=</span> <span class="nx">operatorAccount</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">lockFundsTransaction</span><span class="p">);</span>

    <span class="p">[...]</span>
<span class="p">}</span></code></pre></figure>

<p>6.  Announce the lock funds transaction and wait until it gets confirmed. Then, announce the aggregate bonded transaction.</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="nx">sendSafetySeal</span><span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">const</span> <span class="nx">operatorAccount</span> <span class="o">=</span> <span class="nx">Account</span>
      <span class="p">.</span><span class="nx">createFromPrivateKey</span><span class="p">(</span><span class="nx">form</span><span class="p">.</span><span class="nx">privateKey</span><span class="p">,</span> <span class="nx">NetworkType</span><span class="p">.</span><span class="nx">MIJIN_TEST</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">productPublicKey</span> <span class="o">=</span> <span class="nx">Asset</span><span class="p">.</span><span class="nx">deterministicPublicKey</span><span class="p">(</span><span class="s1">'company'</span><span class="p">,</span> <span class="nx">form</span><span class="p">.</span><span class="nx">selectedProduct</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">productAddress</span> <span class="o">=</span> <span class="nx">PublicAccount</span><span class="p">.</span><span class="nx">createFromPublicKey</span><span class="p">(</span><span class="nx">productPublicKey</span><span class="p">,</span> <span class="nx">NetworkType</span><span class="p">.</span><span class="nx">MIJIN_TEST</span><span class="p">).</span><span class="nx">address</span><span class="p">;</span>

    <span class="kd">const</span> <span class="nx">safetySealTransaction</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">safetySealService</span><span class="p">.</span><span class="nx">createSafetySealTransaction</span><span class="p">(</span><span class="nx">productAddress</span><span class="p">,</span> <span class="nx">operatorAccount</span><span class="p">.</span><span class="nx">publicAccount</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">signedTransaction</span> <span class="o">=</span> <span class="nx">operatorAccount</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">safetySealTransaction</span><span class="o">!</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">lockFundsTransaction</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">safetySealService</span><span class="p">.</span><span class="nx">createLockFundsTransaction</span><span class="p">(</span><span class="nx">signedTransaction</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">signedLockFundsTransaction</span> <span class="o">=</span> <span class="nx">operatorAccount</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">lockFundsTransaction</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">listener</span><span class="p">.</span><span class="nx">open</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">ignored</span> <span class="o">=&gt;</span> <span class="p">{</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">startListeners</span><span class="p">(</span><span class="nx">operatorAccount</span><span class="p">.</span><span class="nx">address</span><span class="p">);</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">transactionHttp</span>
        <span class="p">.</span><span class="nx">announce</span><span class="p">(</span><span class="nx">signedLockFundsTransaction</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">),</span> <span class="nx">err</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">));</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">listener</span>
        <span class="p">.</span><span class="nx">confirmed</span><span class="p">(</span><span class="nx">operatorAccount</span><span class="p">.</span><span class="nx">address</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
          <span class="nx">filter</span><span class="p">((</span><span class="nx">transaction</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">transaction</span><span class="p">.</span><span class="nx">transactionInfo</span> <span class="o">!==</span> <span class="kc">undefined</span>
            <span class="o">&amp;&amp;</span> <span class="nx">transaction</span><span class="p">.</span><span class="nx">transactionInfo</span><span class="p">.</span><span class="nx">hash</span> <span class="o">===</span> <span class="nx">signedLockFundsTransaction</span><span class="p">.</span><span class="nx">hash</span><span class="p">),</span>
          <span class="nx">mergeMap</span><span class="p">(</span><span class="nx">ignored</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">transactionHttp</span><span class="p">.</span><span class="nx">announceAggregateBonded</span><span class="p">(</span><span class="nx">signedTransaction</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">announcedAggregateBonded</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">announcedAggregateBonded</span><span class="p">),</span>
          <span class="nx">err</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">}</span></code></pre></figure>

<h3 id="simulating-the-digital-sensor-behaviour">Simulating the digital sensor behaviour</h3>

<p>The <code class="highlighter-rouge">server</code> already has a service implemented simulating the digital sensor behaviour.</p>

<p>Open <code class="highlighter-rouge">project/server/.env</code>, and add the sensor account’s private key.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">SENSOR_PRIVATE_KEY</span><span class="o">=</span><span class="s1">'134..............526'</span></code></pre></figure>

<p>If you are interested, <a href="https://github.com/nemtech/nem2-workshop-nem-applied-to-supply-chain/blob/v0.2.0/project/server/src/service/sensor.service.ts">review the sensor’s code here</a>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ℹ️ In a production environment, you would need to perform further checks, like reviewing the account who announced the transaction, as well as its content.
</code></pre></div></div>

<p>The server opens a listener connection. It is notified when a new aggregate bonded transaction arrives to this account.</p>

<p>At that moment, <code class="highlighter-rouge">digitalInspection()</code> function is called. It returns a random number between 0 and 5. If it is bigger than 2.5, the product passes the inspection and the transaction is cosigned.</p>

<p>If the number is less than 2.5, the sensor sends a Transfer Transaction with the message <code class="highlighter-rouge">Invalid inspection</code>.</p>

<h2 id="testing-your-changes">Testing your changes</h2>

<p>1. <strong>Restart the server to apply the changes</strong>, and click on the <code class="highlighter-rouge">Send Safety Seal</code> button.</p>

<p>After the lock funds transaction is confirmed, you should see the transaction under <code class="highlighter-rouge">Aggregate bonded added</code> section.</p>

<p><img src="/en/assets/images/screenshot-aggregate-bonded-added.png" alt="screenshot-aggregate-bonded-added" /></p>

<p>The sensor has cosigned the transaction automatically or sent a transfer transaction to your product.</p>

<p>2. Go to the product detail page. Has the product passed the safety test?</p>

<p><img src="/en/assets/images/screenshot-product-detail-inspection-failed.png" alt="screenshot-product-detail-inspection-failed" /></p>

<p>3. Repeat the process several times with different products, until one of them gets the safety seal.</p>

<p><img src="/en/assets/images/screenshot-product-detail-inspection-passed.png" alt="screenshot-product-detail-inspection-passed" /></p>

            </div>
            <div class="page-navigation">
                
                <a class="prev" href="/en/lessons/sending-the-safety-seal/">&laquo; Sending the safety seal</a>
                
                
                <a class="next" href="/en/lessons/adding-another-operator/">Adding another operator &raquo;</a>
                
            </div><a class="u-url" href="/en/lessons/adding-a-digital-sensor/" hidden></a>

        </article>
    </div>

</div>
      </div>
    </main><footer class="site-footer h-card">
    <div class="wrapper">
        <div class="footer-col-wrapper row">

            <div class="footer-col col-4">
                <i class="fas fa-code"></i> <a href="https://nemtech.github.io">Developer Center</a>
            </div>

            <div class="footer-col col-4">
                <i class="fab fa-slack"></i> <a  href="https://join.slack.com/t/nem2/shared_invite/enQtMzY4MDc2NTg0ODgyLTFhZjgxM2NhYTQ1MTY1Mjk0ZDE2ZTJlYzUxYWYxYmJlYjAyY2EwNGM5NzgxMjM4MGEzMDc5ZDIwYTgzZjgyODM">General Discussion</a>
            </div>

            <div class="footer-col col-4">
                <i class="fab fa-stack-overflow"></i><a  href="https://stackoverflow.com/tags/nem/"> Development questions</a>
            </div>
        </div>

    </div>
</footer>
<script
        src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
<script type="text/javascript" src="/en/assets/custom.js"></script></body>

</html>
