<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Adding another operator | NEM blockchain applied to supply chain</title>
<meta name="generator" content="Jekyll v3.8.3" />
<meta property="og:title" content="Adding another operator" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Background" />
<meta property="og:description" content="Background" />
<link rel="canonical" href="http://localhost:4000/en/lessons/adding-another-operator/" />
<meta property="og:url" content="http://localhost:4000/en/lessons/adding-another-operator/" />
<meta property="og:site_name" content="NEM blockchain applied to supply chain" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-03-11T14:48:20+08:00" />
<script type="application/ld+json">
{"headline":"Adding another operator","dateModified":"2019-03-11T14:48:20+08:00","description":"Background","datePublished":"2019-03-11T14:48:20+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/en/lessons/adding-another-operator/"},"@type":"BlogPosting","url":"http://localhost:4000/en/lessons/adding-another-operator/","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/en/assets/main.css">
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/en/feed.xml" title="NEM blockchain applied to supply chain" /></head>
<body><header class="site-header" role="banner">

    <div class="wrapper"><a class="site-title" rel="author" href="/en/"><span><img src="/en/assets/logo-nem.svg"/></span> workshop</a><nav class="site-nav">
            <input type="checkbox" id="nav-trigger" class="nav-trigger" />
            <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
            </label>

            <div class="trigger">
                <div class="changeLanguage">
                <select onchange="changeLanguage('/lessons/adding-another-operator/')" id="languageType">
                  <option value ="language" disabled selected>Language</option>
                  <option value ="en">English</option>
                  <option value ="ch">中文</option>
                </select>
              </div>
                <i class="fab fa-github"></i> <a class="page-link" href="/edit/master/_lessons/12-adding-another-warehouse-operator.markdown"> Edit on GitHub</a>
            </div>
        </nav></div>
</header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="row">

    <div class="sidebar-wrapper col-3">
        <ol><li>
                <a href="/en/lessons/introduction/">
                    Introduction
                </a>
            </li><li>
                <a href="/en/lessons/prepare-your-workstation/">
                    Prepare your workstation
                </a>
            </li><li>
                <a href="/en/lessons/use-case/">
                    Use case: Blockchain applied to supply chain
                </a>
            </li><li>
                <a href="/en/lessons/scope-definition/">
                    Scope definition
                </a>
            </li><li>
                <a href="/en/lessons/authorisation-modelling/">
                    Authorisation modelling
                </a>
            </li><li>
                <a href="/en/lessons/data-modelling/">
                    Data modelling
                </a>
            </li><li>
                <a href="/en/lessons/solution/">
                    One possible solution
                </a>
            </li><li>
                <a href="/en/lessons/setup/">
                    Setup: Warehouse operator and safety seal
                </a>
            </li><li>
                <a href="/en/lessons/registering-products/">
                    Registering products
                </a>
            </li><li>
                <a href="/en/lessons/sending-the-safety-seal/">
                    Sending the safety seal
                </a>
            </li><li>
                <a href="/en/lessons/adding-a-digital-sensor/">
                    Adding a digital sensor
                </a>
            </li><li>
                <a href="/en/lessons/adding-another-operator/">
                    Adding another operator
                </a>
            </li><li>
                <a href="/en/lessons/future-work-multilevel-multisig-accounts/">
                    Future work
                </a>
            </li></ol>

        <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-text="NEM blockchain applied to supply chain #NEM" data-show-count="false">Tweet</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    </div>

    <div class="col-9">
        <article class="lesson h-entry" itemscope itemtype="http://schema.org/BlogPosting">

            <header class="lesson-header">
                <h1 class="lesson-title p-name" itemprop="name headline">Adding another operator</h1>
            </header>

            <div class="lesson-content e-content" itemprop="articleBody">
                <h2 id="background">Background</h2>

<p>Due to recent improvements in technology, the company has increased its productivity. As a result, another warehouse operator has been hired.</p>

<p>Although they could use the same account to send safety seals, the company requires to audit who has performed the action.</p>

<p>The company also inquires to apply conditional logic to the process: If one operator agrees to send the seal, the other one does not have to.</p>

<p><img src="/en/assets/images/use-case-nem-adding-operator.png" alt="use-case-nem-adding-operator" /></p>

<h3 id="multisig-accounts">Multisig Accounts</h3>

<p>NEM allows the creation of <strong><a href="https://nemtech.github.io/concepts/multisig-account.html">multisignature accounts</a></strong>. From that moment on, this  cannot announce transactions by itself. It requires other accounts, called cosignatories, to announce the transactions for them.</p>

<p>It is not always necessary to force all cosignatories to cosign the transaction. The contract is set up specifying the minimum number of cosignatories agreement. These properties can be edited afterwards to suit almost all needs.</p>

<p>Some important considerations to keep in mind:</p>

<ul>
  <li>Once you convert an account to a multisig, you can no longer initiate transactions from that account. Only the cosignatories can start transactions for  the multisig account.</li>
  <li>NEM’s current implementation of multisig is <strong>“M-of-N”</strong>, meaning M can be any number equal to or less than N, i.e., 1-of-4, 2-of-2, 4-of-9, 9-of-10 and so on.</li>
  <li>Multisig accounts can have up to 10 cosignatories.</li>
  <li>An account can be cosigner of up to 5 multisig accounts.</li>
  <li>The number of smallest cosignatures to approve transactions and remove cosignatories is <strong>editable</strong>.</li>
  <li>Multisig accounts can have another multisig as a cosigner, up to 3 levels.</li>
</ul>

<h2 id="solution">Solution</h2>

<h3 id="new-actor-warehouse-operator-2">New Actor: Warehouse Operator 2</h3>

<p>Create an account for the new warehouse operator</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">  nem2-cli account generate <span class="nt">--network</span> MIJIN_TEST <span class="nt">--url</span> http://localhost:3000 <span class="nt">--profile</span> operator2 <span class="nt">--save</span> </code></pre></figure>

<h3 id="safety-department-and-warehouse-multisig-accounts">Safety Department and Warehouse: Multisig Accounts</h3>

<p>1.Create two accounts to represent the warehouse and the safety department.</p>

<p>You are going to implement the <code class="highlighter-rouge">Multisig Service</code>, available at the top-right side of the navbar.</p>

<p><img src="/en/assets/images/screenshot-multisig-service.png" alt="screenshot-multisig-service" /></p>

<p>2. Open <code class="highlighter-rouge">project/dashboard/src/app/services/multisig.service.ts</code> and find <code class="highlighter-rouge">createMultisig</code> function.</p>

<p>3. Replace the alert with the following code:</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="nx">createMultisigAccountTransaction</span><span class="p">(</span><span class="nx">multisigCandidate</span><span class="p">:</span> <span class="nx">PublicAccount</span><span class="p">,</span>
                               <span class="nx">minApproval</span><span class="p">:</span> <span class="nx">number</span><span class="p">,</span>
                               <span class="nx">minRemoval</span><span class="p">:</span> <span class="nx">number</span><span class="p">,</span>
                               <span class="nx">cosignatories</span><span class="p">:</span> <span class="nx">PublicAccount</span><span class="p">[]):</span> <span class="nx">AggregateTransaction</span> <span class="p">{</span>

    <span class="kd">const</span> <span class="nx">newCosignatories</span> <span class="o">=</span> <span class="nx">cosignatories</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">cosignatory</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">publicAccount</span> <span class="o">=</span> <span class="nx">PublicAccount</span><span class="p">.</span><span class="nx">createFromPublicKey</span><span class="p">(</span><span class="nx">cosignatory</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">,</span> <span class="nx">NetworkType</span><span class="p">.</span><span class="nx">MIJIN_TEST</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">MultisigCosignatoryModification</span><span class="p">(</span><span class="nx">MultisigCosignatoryModificationType</span><span class="p">.</span><span class="nx">Add</span><span class="p">,</span> <span class="nx">publicAccount</span><span class="p">);</span>
    <span class="p">});</span>
    
    <span class="kd">const</span> <span class="nx">modifyMultisigAccountTransaction</span> <span class="o">=</span> <span class="nx">ModifyMultisigAccountTransaction</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span>
      <span class="nx">Deadline</span><span class="p">.</span><span class="nx">create</span><span class="p">(),</span>
      <span class="nx">minApproval</span><span class="p">,</span>
      <span class="nx">minRemoval</span><span class="p">,</span>
      <span class="nx">newCosignatories</span><span class="p">,</span>
      <span class="nx">NetworkType</span><span class="p">.</span><span class="nx">MIJIN_TEST</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="nx">AggregateTransaction</span><span class="p">.</span><span class="nx">createComplete</span><span class="p">(</span>
      <span class="nx">Deadline</span><span class="p">.</span><span class="nx">create</span><span class="p">(),</span>
      <span class="p">[</span><span class="nx">modifyMultisigAccountTransaction</span><span class="p">.</span><span class="nx">toAggregate</span><span class="p">(</span><span class="nx">multisigCandidate</span><span class="p">)],</span>
      <span class="nx">NetworkType</span><span class="p">.</span><span class="nx">MIJIN_TEST</span><span class="p">,</span>
      <span class="p">[]);</span>
<span class="p">}</span></code></pre></figure>

<p>We are creating a <code class="highlighter-rouge">ModifyMultisigAccountTransaction</code>, setting the <code class="highlighter-rouge">minApproval</code> passed by parameter, and the list of cosignatories as  <code class="highlighter-rouge">MultisigCosignatoryModification</code>.</p>

<p>4. Go back to the dashboard, and convert the <strong>warehouse</strong> account to a  1-of-2 multisig. Set the <strong>warehouse operators 1 and 2 as cosignatories</strong>.</p>

<p><img src="/en/assets/images/screenshot-multisig-service-warehouse.png" alt="screenshot-multisig-service-warehouse" /></p>

<p>5. Then, convert the <strong>safety department’s</strong> account to a 2-of-2 multisig.  Set the <strong>warehouse’s and sensor’s accounts as cosignatories</strong>.</p>

<p><img src="/en/assets/images/screenshot-multisig-service-safety-department.png" alt="screenshot-multisig-service-company" /></p>

<p>6. Load <code class="highlighter-rouge">safety deparment</code> account with 1.000 <code class="highlighter-rouge">company.safety:seal</code>.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$&gt;</span> nem2-cli transaction transfer <span class="nt">--profile</span> company
Introduce the recipient address: SCSG23-J2BVLU-S4JA4N-ZKMYKV-JR5LTK-M76KJ7-Q2V3
Introduce the mosaics <span class="k">in </span>the format namespaceName:mosaicName::absoluteAmount, add multiple mosaics splitting them with a comma:
<span class="o">&gt;</span> company.safety:seal::1000</code></pre></figure>

<h3 id="modify-aggregate-transaction">Modify aggregate transaction</h3>

<p>1. Open <code class="highlighter-rouge">project/dashboard/src/app/services/safetySeal.service.ts</code>, and find <code class="highlighter-rouge">createSafetySealTransaction</code> function.</p>

<p>2. Add <code class="highlighter-rouge">safety deparment</code> public account as the required signer of the aggregate bonded transaction.</p>

<p>Only the accounts that are not multisig accounts can announce and cosign transactions. For that reason, we opt to announce it with the operator’s account.</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="nx">createSafetySealTransaction</span><span class="p">(</span><span class="nx">productAddress</span><span class="p">:</span> <span class="nx">Address</span><span class="p">,</span> <span class="nx">operatorAccount</span><span class="p">:</span> <span class="nx">PublicAccount</span><span class="p">):</span> <span class="nx">AggregateTransaction</span> <span class="p">{</span>

    <span class="kd">const</span> <span class="nx">safetyDeparmentAccountPublicKey</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span> <span class="c1">// Todo: Paste company account public key</span>
    <span class="kd">const</span> <span class="nx">safetyDeparmentPublicAccount</span> <span class="o">=</span> <span class="nx">PublicAccount</span><span class="p">.</span><span class="nx">createFromPublicKey</span><span class="p">(</span><span class="nx">safetyDeparmentAccountPublicKey</span><span class="p">,</span> <span class="nx">NetworkType</span><span class="p">.</span><span class="nx">MIJIN_TEST</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">safetyDepartmentToProductTransaction</span> <span class="o">=</span> <span class="nx">TransferTransaction</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span>
      <span class="nx">Deadline</span><span class="p">.</span><span class="nx">create</span><span class="p">(),</span>
      <span class="nx">productAddress</span><span class="p">,</span>
      <span class="p">[</span><span class="k">new</span> <span class="nx">Mosaic</span><span class="p">(</span><span class="k">new</span> <span class="nx">MosaicId</span><span class="p">(</span><span class="s1">'company.safety:seal'</span><span class="p">),</span> <span class="nx">UInt64</span><span class="p">.</span><span class="nx">fromUint</span><span class="p">(</span><span class="mi">1</span><span class="p">))],</span>
      <span class="nx">EmptyMessage</span><span class="p">,</span>
      <span class="nx">NetworkType</span><span class="p">.</span><span class="nx">MIJIN_TEST</span>
    <span class="p">);</span>

    <span class="k">return</span> <span class="nx">AggregateTransaction</span><span class="p">.</span><span class="nx">createBonded</span><span class="p">(</span>
      <span class="nx">Deadline</span><span class="p">.</span><span class="nx">create</span><span class="p">(),</span>
      <span class="p">[</span><span class="nx">safetyDepartmentToProductTransaction</span><span class="p">.</span><span class="nx">toAggregate</span><span class="p">(</span><span class="nx">safetyDeparmentPublicAccount</span><span class="p">)],</span>
      <span class="nx">NetworkType</span><span class="p">.</span><span class="nx">MIJIN_TEST</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>3. Open <code class="highlighter-rouge">project/server/.env</code>, and add the safety department’s address.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">SAFETY_DEPARTMENT_ADDRESS</span><span class="o">=</span><span class="s1">'SCSG23-J2BVLU-S4JA4N-ZKMYKV-JR5LTK-M76KJ7-Q2V3'</span></code></pre></figure>

<p>This is required because the sensor listens  the aggregate bonded transactions pending to be signed.</p>

<h2 id="testing-your-changes">Testing your changes</h2>

<p>1. Restart the server to apply the changes.</p>

<p>2. Send a Safety Seal.</p>

<p>3. Go to the product detail page. Has the product passed the safety test? Repeat the process several times with different products, until one of them gets the safety seal.</p>

            </div>
            <div class="page-navigation">
                
                <a class="prev" href="/en/lessons/adding-a-digital-sensor/">&laquo; Adding a digital sensor</a>
                
                
                <a class="next" href="/en/lessons/future-work-multilevel-multisig-accounts/">Future work &raquo;</a>
                
            </div><a class="u-url" href="/en/lessons/adding-another-operator/" hidden></a>

        </article>
    </div>

</div>
      </div>
    </main><footer class="site-footer h-card">
    <div class="wrapper">
        <div class="footer-col-wrapper row">

            <div class="footer-col col-4">
                <i class="fas fa-code"></i> <a href="https://nemtech.github.io">Developer Center</a>
            </div>

            <div class="footer-col col-4">
                <i class="fab fa-slack"></i> <a  href="https://join.slack.com/t/nem2/shared_invite/enQtMzY4MDc2NTg0ODgyLTFhZjgxM2NhYTQ1MTY1Mjk0ZDE2ZTJlYzUxYWYxYmJlYjAyY2EwNGM5NzgxMjM4MGEzMDc5ZDIwYTgzZjgyODM">General Discussion</a>
            </div>

            <div class="footer-col col-4">
                <i class="fab fa-stack-overflow"></i><a  href="https://stackoverflow.com/tags/nem/"> Development questions</a>
            </div>
        </div>

    </div>
</footer>
<script
        src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
<script type="text/javascript" src="/en/assets/custom.js"></script></body>

</html>
